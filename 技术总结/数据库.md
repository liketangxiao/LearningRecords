# 数据库

## 存储引擎

### InnoDB

- 事务型存储引擎

### MyISAM

- 设计简单，适合只读数据

## 系统原理

### 事务

- ACID

### 隔离级别

- 读未提交

	- 出现脏读

- 读提交

	- 出现不可重复读

- 可重复读

	- 出现幻影读

- 可串行化

### 数据库设计理论

- 异常

	- 修改异常，删除异常，插入异常，数据冗余

- 三范式

	- 第一范式

		- 确保每一列的原子性

	- 第二范式

		- 满足1NF，除主键以外的其他列都依赖主键，
确保一个表只做一件事

	- 第三范式

		- 满足2NF，除主键外每一列都直接依赖而非间接依赖，
即每一列只能依赖于主键

- 约束

	- 主键，外键，非空，唯一，默认

## 索引

### B+Tree InnoDB默认索引类型

- 树形结构的磁盘块，由数据项和指针组成
- 数据只存放在叶子节点，加载磁盘块到内存，使用二分查找
- 树的深度，磁盘的大小影响查询的效率

### Hash索引 全文索引

### 索引优化

-  独立索引不能使用函数
- 多条件使用多列索引
- 先使用选择性强的索引列

## 锁 对并发进行处理

### 悲观锁 先加锁,在提交事务,在释放锁

### 乐观锁 先不加锁,是否冲突,提交或回滚  版本号或时间戳

### 锁粒度 行级锁和表级锁，需要在锁开销和并发程度做权衡

## 查询性能优化

### 执行计划Explain分析SELECT语句

### 减少请求的数据量 

- 返回必要的列 不要使用select *
- 返回必要的行 使用where条件 limit
- 缓存重复查询的数据

### 减少服务器扫描的行数

- 使用索引

### 重构大查询

- 切分大查询 大查询锁住数据, 占用事务日志和系统资源,阻塞小查询
- 分解大查询 将Join操作分成单表查询. 是缓存更高效,提升查询效率

### SQL优化

## 切分

### 水平切分Sharding

- 切分策略

	- ID进行hash取模
	- 时间/ID范围
	- 映射表来保存映射关系

- 切分问题

	- 事务使用分布式事务解决
	- join操作分解成单表查询，再在业务逻辑进行join
	- ID唯一性使用唯一ID或分布式ID生成器

### 垂直切分

- 将一张表切分成多张表

## ID生成器

### 数据库auto_increment生成，存在单点问题

### 水平拆分时，使用分区ID自增，扩展性差

### 本地时间，并发高时不能保证唯一性

### snowflake算法按照机器，时间来生成ID

## 复制

### 主从复制

- BinLog线程 写二进制文件(binLog)
- I/O线程 读取binLog并写入从服务器
- SQL线程 从日志中重放其中的SQL语句

### 读写分离

- 主服务器 写及实时性强的读操作
- 从服务器 使用MyISAM引擎提高性能

## SQL

### 增删改查

### 子查询

### 连接

### 视图 

### 存储过程

-  代码封装, 代码复用, 代码预编译
- in out inout

### 游标 对结果集进行遍历

- 声明游标
- 打开游标
- 取出数据
- 关闭游标

### 触发器

-  执行insert,delete,update语句时自动执行
- 指明AFTER或BEFORE
- 虚拟表NEW或OLD

### 事务

