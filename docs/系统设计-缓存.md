# 缓存

缓存的目的是加快数据的读取，有效减少核心应用、数据库的压力。

我们在使用缓存提高读取性能的同时，**一定会失去一定的一致性**。

## 特征

### 命中率

- 缓存命中率越高, 缓存利用率越高

### 最大空间

- 缓存一般位于内存中, 当缓存使用空间超过最大空间时, 就要使用淘汰策略淘汰数据

### 淘汰策略

- FIFO 先进先出

  实时性要求高的数据, 先进入的数据先被淘汰

- LRU 最久未使用策略

  保证缓存中的数据都是热点数据

- LFU 最不经常使用策略

缓存位置

## 缓存设计

### CPU占用高

- 正则表达式计算占用CPU
考虑将计算结果缓存起来

### 数据库IO占用高

- 连接池比较繁忙，将查询结果缓存
解决数据库IO占用，提高查询性能

## 缓存位置

### 浏览器

当设置允许缓存时, 浏览器会将html, css, javascript等静态资源缓存起来, 提高响应

### 网络服务提供商(ISP)

ISP是网络访问的第一跳, 将数据缓存在ISP中将减少用户响应时间

### 反向代理

反向代理位于服务器之间, 请求和响应都会经过反向代理, 将数据缓存在反向代理, 可以使用缓存直接响应

### 本地缓存

可以直接从内存中读取数据, 非常快

### 分布式缓存

使用redis等分布式缓存系统

## 数据库缓存

Mysql等数据库都有一套缓存机制, 用来提高查询效率

## Java内部缓存

常量池和缓存池提高字符串, 基本类型创建的效率

### CPU多级缓存

为了解决CPU运算速度和磁盘IO速度不匹配, 引入多级缓存结构

## 进程内缓存

### 适合数据量较小，更新不频繁的数据
如果更新频繁，可以设置较短超时时间

### concurrentHashMap

- 缓存较小，固定不变的，如反射的Method,feild,链接

### LRUMap

- 有淘汰数据的算法

### Guava Chache

- 第三方缓存

### Caffeine

- 第三方缓存，支持淘汰算法，读写性能比Guava Chache好

## 分布式缓存

### 适合大量数据，更新频率高的数据

### MemCache

- 只支持key-value，不支持持久化，但吞吐量好

### Redis

- 数据结构丰富，支持持久化

### Tair

- 数据结构丰富，支持持久化

## 多级缓存

### 问题，有redis做缓存了，为什么还需要进程内缓存

- redis在全量同步时不可用，会造成雪崩

- redis会有IO序列化和反序列化，没本地方法快

- 缓存更新，使用redis的pud/sub通知应用更新缓存，redis挂了也可以使用超时设定去刷新缓存

## 缓存更新

### 先删缓存，再更新数据库

- 问题：删了缓存有读数据依然是旧数据，然后再缓存旧数据

### 先更新数据库，再删缓存

- 问题：

## 缓存问题

### 缓存穿透

- 数据库没有，缓存自然没有，这样请求多数据库压力就大
- 设计将null结果也缓存起来，增加维护成本，
在插入的时候删除缓存，或设置超时时间
- 设置过滤器将一些不可能存在的数据直接过滤，
小数据用bitMap,大数据用布隆过滤器

### 缓存击穿

- 缓存设置超时时间，热点数据key删除后大量请求访问数据库
- 设计分布式锁，加载数据锁住这个数据key，
其他线程可以采用重试策略
- 设计超时时间自动刷新，而不是到期自动淘汰

### 缓存雪崩

- 缓存不可用或者大量缓存同时失效，请求直接访问数据库
数据库压力过大导致系统雪崩
- 设计监控系统缓存的健康程度，适当扩容缓存
- 采用多级缓存，不同级别设置超时时间不同
- 设置随机缓存过期时间，尽量让key不是同时过期

### 缓存一致性

- 要保证缓存一致性

  使用消息队列, 删除失败时有重试机制

  使用数据库binlog机制, 根据日志执行缓存失败重试

- 最好缓存一致性要求不高的数据, 允许存在脏数据

### 缓存无底洞现象

- 因业务需求添加过多缓存节点, 通过hash计算出key的缓存节点, 导致值缓存在更多的节点, 一次批量操作会进行多次的网络操作, 从而影响性能
  - 优化批量数据操作命令
  - 降低接入成本, NIO,长连接,连接池

## 设计会忽略的点

### 序列化

### GC调优

### 缓存监控

